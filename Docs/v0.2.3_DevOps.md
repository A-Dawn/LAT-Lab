## 安全更新 (2025-07-25)

本次更新对系统进行了全面的安全审查和加固，修复了多个安全漏洞，显著提升了系统整体安全性。

### 1. 路径遍历漏洞修复

修复了多个潜在的路径遍历漏洞，这些漏洞可能允许攻击者通过构造特殊的文件路径访问系统中未授权的文件。

#### 修复内容

- **文件名安全验证机制**
  - 实现了`secure_filename`函数用于安全处理文件名和路径
  - 对所有用户提供的文件名进行严格过滤，移除路径分隔符和特殊字符
  - 确保文件名不以点或破折号开头，防止访问隐藏文件
  - 保证文件名非空，设置默认安全值

- **受影响模块**
  - 插件系统 (`plugin.py`): 修复了示例插件获取和列表功能中的路径构建逻辑
  - 文件上传 (`upload.py`): 加强了对上传文件名的验证和处理
  - 用户头像 (`user.py`): 确保头像文件路径构建的安全性

- **安全实践应用**
  - 采用"白名单"原则，仅允许安全的字符集
  - 使用`os.path.basename`移除所有路径信息
  - 使用正则表达式过滤非安全字符
  - 统一应用安全机制，确保全系统一致性

### 2. 敏感数据安全存储加强

修复了前端敏感数据存储机制中的安全漏洞，特别是针对用户偏好和交互数据的存储。

#### 修复内容

- **安全加密工具库**
  - 新增`crypto.js`工具库，实现基于Web Crypto API的安全存储功能
  - 使用PBKDF2密钥派生函数增加计算复杂度，防止暴力破解
  - 通过HMAC签名确保数据完整性，防止篡改
  - 实现安全的会话存储和检索方法

- **密码保护文章安全加固**
  - 修复`getArticleWithPassword`函数，使用SHA-256哈希处理密码，避免明文传输
  - 添加客户端哈希标识，与后端API协同工作
  - 实现数据降级处理机制，确保向后兼容性
  - 防止敏感文章内容在会话存储中以明文方式保存

- **点赞功能安全加固**
  - 将简单的JSON序列化替换为安全的加密存储
  - 实现向后兼容的数据格式转换，支持平滑升级
  - 增加时间戳验证，防止数据重放攻击

- **依赖升级**
  - 更新`crypto-js`依赖至4.2.0版本，修复已知安全漏洞
  - 确保所有密码学相关库使用最新安全版本

### 3. 前端登录认证机制加强

修复了登录认证流程中的多个安全问题，确保用户凭据安全传输和处理。

#### 修复内容

- **登录请求格式优化**
  - 修复了Content-Type与请求体格式不匹配问题
  - 将`FormData`替换为`URLSearchParams`，确保正确处理`application/x-www-form-urlencoded`格式
  - 优化了登录失败处理机制，提供安全的错误提示

- **敏感信息保护**
  - 移除了敏感信息的日志记录，避免密码长度等信息泄露
  - 清理登录前的缓存数据，防止会话混淆攻击
  - 增强了URL重定向安全检查，防止开放重定向漏洞

### 4. 用户管理工具增强

增加了安全的用户管理工具，确保用户创建和验证过程的安全性。

#### 修复内容

- **用户创建脚本**
  - 添加`create_user.py`脚本，支持安全创建管理员或普通用户
  - 实现与系统相同的密码哈希算法，确保用户凭据安全性
  - 完善用户数据验证，增加邮箱验证状态管理

- **登录验证工具**
  - 开发`test_login_user.py`测试工具，用于验证登录机制
  - 提供详细的错误信息，便于排查认证问题
  - 确保与生产环境使用相同的验证流程

## 安全建议

1. **立即更新**：所有用户应立即更新到最新版本
2. **重置管理员密码**：建议在更新后重置所有管理员密码
3. **检查配置**：确保配置文件中的SECRET_KEY已更新为强随机值
4. **验证数据安全**：查看前端控制台日志，确保没有敏感信息泄露